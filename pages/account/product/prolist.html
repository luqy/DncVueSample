<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>产品管理</title>
    <link rel="stylesheet" type="text/css" href="../../../assets/iview/iview-3.1.0/styles/iview.css" />
    <script src="../../../assets/vue/vue-2.5.17.min.js"></script>
    <script src="../../../assets/iview/iview-3.1.0/iview.min.js"></script>
  <script src="../../../assets/axios/axios.js"></script>
  <script src="../../../js/config.js"></script>
</head>

<body>
    <div id="app">
        <i-Button type="primary" @click="modal1 = true">Display dialog box</i-Button>
        <Modal
                v-model="modal1"
                title="添加产品"
                @on-ok="ok"
                @on-cancel="cancel"
        >
            <i-form ref="formValidate" :model="formValidate" :rules="ruleValidate" :label-width="80">
                <Form-item label="姓名" prop="name">
                    <i-input v-model="formValidate.pdt_name" placeholder="Username"></i-input>
                </Form-item>
                <Form-item label="产品版本" prop="version">
                    <i-input v-model="formValidate.version" placeholder="Username"></i-input>
                </Form-item>
                <Form-item label="产品地址" prop="host">
                    <i-input v-model="formValidate.host" placeholder="Username"></i-input>
                </Form-item>
                <Form-item label="产品描述" prop="description">
                    <i-input v-model="formValidate.pdt_name" placeholder="Username"></i-input>
                </Form-item>
                <Form-item label="文件上传" >
                    <i-input type="file" class="file"  v-on:click="tirggerFile"/>
<!--                    <Upload action="//jsonplaceholder.typicode.com/posts/" >
                        <i-Button icon="ios-cloud-upload-outline">Upload files</i-Button>
                    </Upload>-->
                </Form-item>
                <Form-item label="api_json" prop="host">
                    <i-input v-model="formValidate.api_json" placeholder="Username"></i-input>
                </Form-item>
            </i-form>

        </Modal>
      <i-Table :border="showBorder" :stripe="showStripe" :show-header="showHeader"
             :height="fixedHeader ? 250 : ''" :size="tableSize" :data="tableData3" :columns="tableColumns3"></i-Table>
    </div>
    <script type="text/javascript">
        var vm = new Vue({
            el: "#app",
            data: function () {
                return {
                    modal1: false,
                    formValidate: {
                        pdt_name: '',
                        version: '',
                        host: '',
                        description: '',
                        api_json: ''
                    },
                    ruleValidate: {
                        pdt_name: [
                            { required: true, message: 'The name cannot be empty', trigger: 'blur' }
                        ],
                        host: [
                            { required: true, message: 'The host cannot be empty', trigger: 'blur' }
                        ],
                        version: [
                            { required: true, message: 'The host cannot be empty', trigger: 'blur' }
                        ],
                        description: [
                            { required: true, message: 'Please enter a personal introduction', trigger: 'blur' },
                            { type: 'string', min: 10, message: 'Introduce no less than 20 words', trigger: 'blur' }
                        ],
                        api_json: [
                            { required: true, message: 'The host cannot be empty', trigger: 'blur' }
                        ]
                    },
                  tableData3: [
                      {
                        'pdt_id': 12,
                        'pdt_name': '集成平台1.0',
                        'version': '集成平台1.0——V1.1.7.0_12&13',
                        'host': '192.168.1.50:8888',
                        'description': '这个是一个产品名称示例，请按照标准进行编写'
                      }
                    ],
                  showBorder: false, // 显示边框
                  showStripe: true, // 是否显示斑马纹
                  showHeader: true, // 是否显示头部信息
                  showIndex: false, // 是否显示索引
                  showCheckbox: true, // 显示多选框
                  fixedHeader: false, // 显示滑动
                  tableSize: 'default'
                }
            },
          computed: {
            tableColumns3 () {
              let columns = []
              if (this.showCheckbox) {
                columns.push({
                  type: 'selection',
                  width: 60,
                  align: 'center'
                })
              }
              if (this.showIndex) {
                columns.push({
                  type: 'index',
                  width: 60,
                  align: 'center'
                })
              }
              columns.push({
                title: 'ID',
                key: 'pdt_id',
                sortable: true
              })
              console.log("length:"+this.tableData3.length)
              var filters_name1=[];
              for(var i = 0; i <this.tableData3.length; i++){
                var filters_name0={
                  label:this.tableData3[i].pdt_name,
                  value: this.tableData3[i].pdt_name
                }
                filters_name1.push(filters_name0);
              }
              console.log("file:"+JSON.stringify(filters_name1));
              columns.push({
                title: '产品名称',
                key: 'pdt_name',
                filters:filters_name1 ,
                filterMethod (value, row) {
                  return row.pdt_name.indexOf(value) > -1
                }
              })
              columns.push({
                title: '产品版本',
                key: 'version'
              })
              columns.push({
                title: '产品地址',
                key: 'host',
                sortable: true,
                filters: [
                  {
                    "label": 'Greater than 25',
                    "value": "1"
                  },
                  {
                    "label": 'Less than 25',
                    "value": "2"
                  }
                ],
                filterMultiple: false,
                filterMethod (value, row) {
                  if (value === 1) {
                    return row.age > 25
                  } else if (value === 2) {
                    return row.age < 25
                  }
                }
              })
              columns.push({
                title: '产品描述',
                key: 'description'
              })
              columns.push({
                title: 'Action',
                key: 'action',
                render: (h, params) => {
                  return h('div', [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginRight: '5px'
                      },
                      on: {
                        click: () => {
                          this.show(params.index)
                        }
                      }
                    }, 'View'),
                    h('Button', {
                      props: {
                        type: 'error',
                        size: 'small'
                      },
                      on: {
                        click: () => {
                          this.remove(params.index)
                        }
                      }
                    }, 'Delete')
                  ])
                }
              })
              console.log("columns"+JSON.stringify(columns))
              return columns
            }
          },
          mounted:function(){
            axios.get(''+host+'/api/product/getproductlist')
              .then(res => {
                console.log(res)
                this.tableData3 = res.data.message
                this.filters=this.tableData3.pdt_name
              })
              .catch(function (error) {
                console.log(error)
              });

          },
          methods:{
            remove: function (index) {
              console.log('date1' + this.tableData3[index].pdt_id)
              // 格局id删除数据
              var obj = {pdt_id: this.tableData3[index].pdt_id}
              this.tableData3.splice(index, 1)
              // var url = '/api/product/delproduct'
              // 发送异步请求
              this.$axios({
                url: '/api/product/delproduct',
                method: 'delete',
                dataType: 'json',
                headers: {
                  'Content-type': 'application/json;'
                },
                data: JSON.stringify(obj),
              }).then(res => {
                if (res.status === 200) {
                  alert('success')
                  // 更新数据
                  console.log(res.message)
                  this.tableData3.splice(index, 1)
                } else {
                  alert(res.message)
                }
              }).catch(function () {
                alert('服务连接出错了')
              })
            },
            show (index) {
              this.$Modal.info({
                title: '编辑产品',
                width: '900px',
                fullscreen:true,
                content: `
 <p>测试一下</p>`,
                onOk: () => {
                  this.$Message.info('点击了确定');
                },
                onCancel: () => {
                  this.$Message.info('点击了取消');
                }
              })
            },
            ok () {
              this.$Message.info('点击了确定');
              console.log("123:"+JSON.stringify(this.formValidate));

            },
            cancel () {
              this.$Message.info('Clicked cancel');
            },
              tirggerFile: function (event) {
                  // 此处校验文件后缀
                  var self = this
                  var file = event.target.files[0]
                      .name // (利用console.log输出看file文件对象) properties/xml/json/conf/config/data/ini/txt/yaml/yml/cfg
                  var num = file.split('.')
                  var mun = num[num.length - 1]
                  console.log(mun)
                  if (!(mun == 'ini' || mun == 'properties' || mun == 'xml' || mun == 'json' || mun == 'conf' || mun ==
                      'config' ||
                      mun == 'data' || mun == 'txt' || mun == 'config' || mun == 'yaml' || mun == 'cfg')) {
                      this.$Notice.error({
                          title: '请重新点击选择文件传入符合标准的文件',
                          duration: 2
                      })
                  } else {
                      let fileselect = document.querySelector('input[type=file]').files[0] // 找到文件上传的元素
                      let reader = new FileReader()
                      // console.log(fileselect);
                      if (typeof FileReader === 'undefined') {
                          alert('您的浏览器不支持FileReader接口')
                      }
                      reader.readAsText(fileselect, 'gb2312') // 注意读取中文的是用这个编码，不是utf-8
                      reader.onload = function () {
                          console.log(reader.result)// 文件内容
                          let api_json = reader.result
                          self.formValidate.api_json = api_json
                      }
                  }
              }
          }

        });
    </script>
</body>

</html>
