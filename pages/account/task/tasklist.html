<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>任务列表</title>
    <link rel="stylesheet" type="text/css" href="../../../assets/iview/iview-3.1.0/styles/iview.css" />
    <script src="../../../assets/vue/vue-2.5.17.min.js"></script>
    <script src="../../../assets/iview/iview-3.1.0/iview.min.js"></script>
    <script src="../../../assets/axios/axios.js"></script>
    <script src="../../../js/config.js"></script>
</head>

<body>
<div id="app">
    <i-Button type="primary" @click="modal1 = true">添加任务</i-Button>
    <Modal
            v-model="modal1"
            title="添加任务"
            @on-ok="ok"
            @on-cancel="cancel"

    >
        <i-form ref="formValidate" :model="formValidate" :rules="ruleValidate" :label-width="80">
            <Form-item label="任务名称" prop="task_name">
                <i-input v-model="task_name" placeholder="请输入产品名称"></i-input>
            </Form-item>
            <Form-item label="类型" prop="host">
                <Radio-Group v-model="task_typeID" >
                    <Radio label="1">性能</Radio>
                    <Radio label="2">接口</Radio>
                </Radio-Group>
            </Form-item>
            <Form-item label="性能CASE列表"   v-if="task_typeID=== '1'">
                <dl v-for="(item,index) in performance" :key="item">
                    <label>
                        <input type="checkbox" v-model="case_token" :value="item">
                    </label>
                    {{item.case_name}}

                </dl>
            </Form-item>
            <Form-item label="接口CASE列表"   v-if="task_typeID=== '2'">
                <dl v-for="(item,index) in interface" :key="index">
                    <label >
                        <input type="checkbox" v-model="case_token" :value="item">
                    </label>
                    {{item.case_name}}

                </dl>
            </Form-item>
        </i-form>

    </Modal>
    <i-Table :loading="loading" :border="showBorder" :stripe="showStripe" :show-header="showHeader"
             :height="fixedHeader ? 250 : ''" :size="tableSize" :data="tableData3" :columns="tableColumns3"></i-Table>

    <Modal
            v-model="editFormVisible"
            title="编辑产品"
            @on-ok="update"
            @on-cancel="cancel"
    >
        <i-form ref="editForm" :model="editForm" :rules="ruleValidate" :label-width="80">
            <Form-item label="产品名称" prop="pdt_name">
                <i-input v-model="editForm.pdt_name" placeholder="请输入产品名称"></i-input>
            </Form-item>
            <Form-item label="产品版本" prop="version">
                <i-input v-model="editForm.version" placeholder="请输入产品版本号 "></i-input>
            </Form-item>
            <Form-item label="产品地址" prop="host">
                <i-input v-model="editForm.host" placeholder="请输入产品地址"></i-input>
            </Form-item>
            <Form-item label="产品描述" prop="description">
                <i-input v-model="editForm.description" placeholder="请输入产品描述"></i-input>
            </Form-item>
            <!--                <Form-item label="文件上传" >
                                <i-input type="file" class="file"  @change="tirggerFile"/>
            &lt;!&ndash;                    <Upload action="//jsonplaceholder.typicode.com/posts/" >
                                    <i-Button icon="ios-cloud-upload-outline">Upload files</i-Button>
                                </Upload>&ndash;&gt;
                            </Form-item>-->
            <Form-item label="api_json" prop="api_json">
                <i-input v-model="editForm.api_json" placeholder="请输入接口字符串"></i-input>
            </Form-item>
        </i-form>

    </Modal>

</div>
<script type="text/javascript">
    var vm = new Vue({
        el: "#app",
        data: function () {
            return {
                loading: false,
                task_name:'',
                checkedNames:[],
                case_pdt0:'',
                case_pdt:'',
                case_apidata:'',
                case_token:[],
                case_input:[],
                task_typeID:'',
                casedate:[{
                    "case_name": "按需服务1",
                    "api_weight": [
                        {
                            "api_id": "20",
                            "weight": "1"
                        },
                        {
                            "api_id": "21",
                            "weight": "1"
                        },
                    ],
                    "type_id": '1',
                }],
                editFormVisible:false,
                editFormRules: {
                    name: [
                        { required: true, message: '请输入姓名', trigger: 'blur' }
                    ]
                },
                editForm: {
                    pdt_id:'' ,
                    pdt_name: '',
                    version: '',
                    host: '',
                    description: '',
                    api_json:'',

                },
                modal1: false,
                formValidate: {
                    type_id:'1',
                },
                ruleValidate: {
                    pdt_name: [
                        { required: true, message: '产品名称不能为空', trigger: 'blur' }
                    ],
                    host: [
                        { required: true, message: '产品地址不能为空', trigger: 'blur' }
                    ],
                    version: [
                        { required: true, message: '产品版本不能为空', trigger: 'blur' }
                    ],
                    description: [
                        { required: true, message: '请输入产品描述', trigger: 'blur' },
                    ],
                    api_json: [
                        { required: true, message: '产品接口字符串不能为空', trigger: 'blur' }
                    ]
                },
                tableData3: [

                ],
                showBorder: false, // 显示边框
                showStripe: true, // 是否显示斑马纹
                showHeader: true, // 是否显示头部信息
                showIndex: false, // 是否显示索引
                showCheckbox: true, // 显示多选框
                fixedHeader: false, // 显示滑动
                tableSize: 'default',
                interface:[],
                performance:'',

            }
        },
        watch:{
task_typeID(val,oldval){
    var  performance0=[];
    var  interface0=[];
        console.log("val:"+val);
        for(var i=0;i<this.case_pdt.length;i++){
            if(this.case_pdt[i].type_id===1){
                performance0.push({
                    case_id:this.case_pdt[i].case_id,
                    case_name:this.case_pdt[i].case_name,
                })
                //console.log("performance0:"+performance0)
            }
            else if(this.case_pdt[i].type_id===2){
                interface0.push({
                    case_id:this.case_pdt[i].case_id,
                    case_name:this.case_pdt[i].case_name,
                })
                //console.log("interface0:"+interface0)

            }
        }
    this.performance=performance0;
    this.interface=interface0;
/*    console.log("performance1:"+performance0)
    console.log("interface1:"+interface0)
    console.log("interfance2:"+JSON.stringify(this.interface))*/
}
        },
        computed: {
            tableColumns3: function () {
                let columns = []
                if (this.showCheckbox) {
                    columns.push({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                }
                if (this.showIndex) {
                    columns.push({
                        type: 'index',
                        width: 60,
                        align: 'center'
                    })
                }
                columns.push({
                    title: 'ID',
                    key: 'task_id',
                    sortable: true,

                })

                columns.push({
                    title: '任务名称',
                    key: 'task_name'
                });
                columns.push({
                    title: '运行状态',
                    key: 'task_status',
                    width:200,
                });
                columns.push({
                    title: '任务类型',
                    key: 'type_id',
                    render: (h, params) => {
                        return  h('span',params.row.type_id === 1 ?'性能' : params.row.type_id === 2? '接口' : '未知')
                    }
                });
                columns.push({
                    title: '运行参数',
                    key: 'parameter',
                    tooltip:true,
                    width:500,
                });
                columns.push({
                    title: '任务执行',
                    key: 'action',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {

                                    icon:"md-paper",//生成脚本
                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        this.addsript(params.row)
                                    }
                                }
                            }),
                            h('Button', {
                                props: {
                                    icon:"md-play",//运行

                                    size: 'buttonSize'

                                },
                                style: {
                                    marginRight: '5px',
                                    display:(params.row.task_status===true)?"none":"inline-block",
                                },
                                on: {
                                    click: () => {
                                        this.taskrun(params.row)
                                    }
                                }
                            }),
                            h('Button', {
                                props: {
                                    icon:"md-pause",//停止

                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px',
                                    display:(params.row.task_status===false)?"none":"inline-block",
                                },
                                on: {
                                    click: () => {
                                        this.taskstop(params.row)
                                    }
                                }
                            }, ),
                        ])
                    }
                })
                columns.push({
                    title: 'Action',
                    key: 'action',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    icon:"ios-create-outline",//编辑
                                    shape:"circle",
                                    size: 'buttonSize'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        this.show(params.index)
                                    }
                                }
                            },'编辑'),
                            h('Button', {
                                props: {
                                    type: 'error',
                                    icon:"ios-trash-outline",//删除
                                    shape:"circle",

                                    size: 'buttonSize'
                                },
                                on: {
                                    click: () => {
                                        this.remove(params.index)
                                    }
                                }
                            },'删除')
                        ])
                    }
                })
                console.log("columns" + JSON.stringify(columns))
                return columns
            }
        },
        created:function(){
            axios.get(''+host+'/api/taskinfo/taskmagager')
                .then(res => {
                    console.log(res)
                    /*this.tableData3 = res.data.message*/
                    //this.filters=this.tableData3.pdt_name
                    this.tableData3=res.data.message
                    console.log("task2:"+this.tableData3.length)
                    axios.get(''+host+'/api/caseinfo/caselist')
                        .then(res => {
                            console.log(res)
                            this.case_pdt = res.data.message
                            console.log("task4:"+this.tableData3.length)
                            console.log(this.case_pdt)
                            for(var i=0;i<this.tableData3.length;i++){

                            }


                        })
                        .catch(function (error) {
                            console.log(error)
                        });
                    console.log("task3:"+this.case_pdt)
                })
                .catch(function (error) {
                    console.log(error)
                });

        },
        mounted:function(){
            console.log("task:"+this.tableData3.length)
        },
        methods:{
            //脚本生成
            addsript:function(event) {
                console.log("cs；" + JSON.stringify(event))
                if (event.type_id === 1) {
                    console.log("cs1；" + event.task_id)
                    axios.get('' + host + '/api/taskscript-performance?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res)
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            (error)
                        });
                } else if (event.type_id === 2) {
                    console.log("cs2；" + JSON.stringify(event))
                    axios.get('' + host + '/api/taskscript-interface?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res)
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            alert(error)
                        });
                }
            },
            //运行停止
            taskrun:function(event){
                console.log("taskrun；" + JSON.stringify(event))
                if (event.type_id === 1) {
                    console.log("run1；" + event.task_id)
                    axios.get('' + host + '/api/task-performance?order=1&task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res)
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            (error)
                        });
                } else if (event.type_id === 2) {
                    this.loading=true;
                    console.log("cs2；" + JSON.stringify(event))
/*                    axios.get('' + host + '/api/task-interface?task_id=' + event.task_id + '')
                        .then(res => {
                            console.log(res)
                            alert("操作:" + res.data.title + ",\n结果:" + res.data.message)
                        })
                        .catch(function (error) {
                            alert(error)
                        });*/
                axios.interceptors.request.use(config=>{
                    config.baseURL='' + host + '/api/task-interface?task_id=' + event.task_id + '',
                        config.tiemout=6000;
                })
                }
    },
            taskstop:function(index){

            },
            //删除按钮
            remove: function (index) {
                console.log('date1' + this.tableData3[index].pdt_id)
                // 格局id删除数据
                var obj = {pdt_id: this.tableData3[index].pdt_id}
                this.tableData3.splice(index, 1)
                // var url = '/api/product/delproduct'
                // 发送异步请求
                axios({
                    url: ''+host+'/api/product/delproduct',
                    method: 'delete',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(obj),
                }).then(res => {
                    if (res.status === 200) {
                        alert('success')
                        // 更新数据
                        console.log(res.message)
                        this.tableData3.splice(index, 1)
                    } else {
                        alert(res.message)
                    }
                }).catch(function () {
                    alert('服务连接出错了')
                })
            },
            //点击编辑
            show (index) {
                this.editFormVisible=true;
                console.log("shouw"+JSON.stringify(this.tableData3[index]))
                this.editForm=this.tableData3[index];
                //this.editForm.api_json=JSON.parse(this.editForm.api_json)
                console.log("shouw1"+JSON.stringify(this.editForm))
                /*                  this.$Modal.confirm({
                                      title: '编辑产品',
                                      fullscreen:true,
                                      title: '编辑产品',
                                      content: `
                                              产品名称：<input size="35"v-bind:value="${this.tableData3[index].pdt_name}"
                  v-on:input="${this.tableData3[index].pdt_name} = $event.target.value" /><br>
                                             <br>产品版本：<input  size="35"value="${this.tableData3[index].version}"/><br>
                                             <br>产品地址：<input size="35" value="${this.tableData3[index].host}"/><br>
                                             <br>产品描述：<input size="35" value="${this.tableData3[index].description}"/><br>
                                             <br>api_json ：<input  size="35" value=${JSON.stringify(this.tableData3[index].api_json)}/>`,
                                      onOk: () => {
                                          this.$Message.info('点击了确定');
                                          console.log("修改数据:"+JSON.stringify(this.tableData3[index]));
                                          axios({
                                              url: ''+host+'/api/product/updateproduct',
                                              "method": "PUT",
                                              dataType: 'json',
                                              headers: {
                                                  'Content-type': 'application/json;'
                                              },
                                              data: JSON.stringify(this.tableData3[index]),
                                          }).then(function (response){
                                              console.log("修改产品："+JSON.stringify(response))
                                              alert("操作:"+response.data.title+",\n结果:"+response.data.message)
                                              location.reload()

                                          })
                                              .catch(function(error){
                                                  console.log(error)
                                              })

                                      },
                                      onCancel: () => {
                                          this.$Message.info('点击了取消');
                                      }
                                  })*/
            },
            //添加弹窗点击确定
            ok :function (){
                //let api_json = JSON.parse(this.case_api )
                //this.formValidate.api_json=api_json
                console.log("task_list:"+JSON.stringify(this.case_token));
                console.log("task_name:"+JSON.stringify(this.task_name));
                console.log("task_typeID:"+JSON.stringify(this.task_typeID));
                if(this.task_typeID==='1'){
                    var obj={
                        "task_name":this.task_name,
                        "associated_case":this.case_token,
                        "task_status": false,
                        "locust_cl": [
                            {
                                "need": 1,
                                "parameter": "--host=127.0.0.1"
                            },
                            {
                                "need": 1,
                                "parameter": "--web-host=192.168.1.21"
                            },
                            {
                                "need": 1,
                                "parameter": "--web-port=8182"
                            }],
                        "pytest_para":[]
                    }
                }else if(this.task_typeID==='2'){
                    var obj={
                        "task_name":this.task_name,
                        "associated_case":[],
                        "task_status": false,
                        "locust_cl":[],
                        "pytest_para":this.case_token
                    }
                }

                console.log("api_id10:"+JSON.stringify(obj))
                axios({
                    //url: ''+host+'/api/caseinfo/case',
                    method: 'post',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(obj),
                }).then(function (response){
                    console.log(response)
                    alert("操作:"+response.data.title+",\n结果:"+response.data.message)
                    //location.reload()

                })
                    .catch(function(error){
                        alert("请求超时")
                        console.log(error)
                    })

            },
            //编辑
            update() {
                console.log("修改:"+JSON.stringify(this.editForm));
                this.editForm.api_json=JSON.parse(this.editForm.api_json)
                axios({
                    url: ''+host+'/api/product/updateproduct',
                    method: 'put',
                    dataType: 'json',
                    headers: {
                        'Content-type': 'application/json;'
                    },
                    data: JSON.stringify(this.editForm),
                }).then(function (response){
                    console.log(response)
                    alert("操作:"+response.data.title+",\n结果:"+response.data.message)
                    location.reload()

                })
                    .catch(function(error){
                        console.log(error)
                    })

            },
            cancel () {
                this.$Message.info('已取消');
                this.formValidate = {
                    pdt_name: '123',
                    version: '',
                    host: '',
                    description: '',
                    api_json: ''
                };
                //location.reload()
            },

        }
    });
</script>
</body>

</html>
